{% extends "base.html" %}

{% block title %}Assignments - AI Study Assistant{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>All Assignments</h1>
        <a href="{{ url_for('add_assignment') }}" class="btn btn-primary">
            ➕ Add Assignment
        </a>
    </div>

    <div class="filters">
        <form method="GET" action="{{ url_for('assignments') }}" class="filter-form">
            <div class="filter-group">
                <label for="priority">Priority:</label>
                <select name="priority" id="priority" class="form-control" onchange="this.form.submit()">
                    <option value="all" {% if priority_filter == 'all' %}selected{% endif %}>All</option>
                    <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
                    <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="status">Status:</label>
                <select name="status" id="status" class="form-control" onchange="this.form.submit()">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="overdue" {% if status_filter == 'overdue' %}selected{% endif %}>Overdue</option>
                </select>
            </div>
            
            {% if priority_filter != 'all' or status_filter != 'all' %}
                <a href="{{ url_for('assignments') }}" class="btn btn-secondary btn-small">Clear Filters</a>
            {% endif %}
        </form>
    </div>

    {% if assignments %}
        <div class="assignments-table-container">
            <table class="assignments-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Due Date</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in assignments %}
                        <tr class="row-status-{{ assignment.status }}">
                            <td>
                                <strong>{{ assignment.title }}</strong>
                                {% if assignment.description %}
                                    <br><small class="text-muted">{{ assignment.description[:80] }}{% if assignment.description|length > 80 %}...{% endif %}</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ assignment.due_date.strftime('%b %d, %Y') }}
                                {% set days_remaining = (assignment.due_date - now).days %}
                                {% if assignment.status != 'completed' %}
                                    <br>
                                    {% if days_remaining < 0 %}
                                        <small class="text-danger">Overdue</small>
                                    {% elif days_remaining == 0 %}
                                        <small class="text-warning">Due today</small>
                                    {% elif days_remaining <= 3 %}
                                        <small class="text-warning">{{ days_remaining }} days</small>
                                    {% else %}
                                        <small class="text-muted">{{ days_remaining }} days</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge badge-priority-{{ assignment.priority }}">
                                    {{ assignment.priority|capitalize }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-status-{{ assignment.status }}">
                                    {{ assignment.status|capitalize }}
                                </span>
                            </td>
                            <td class="actions-cell">
                                {% if assignment.status != 'completed' %}
                                    <button onclick="markComplete({{ assignment.id }})" 
                                            class="btn btn-success btn-small"
                                            title="Mark as completed">
                                        ✓ Complete
                                    </button>
                                {% endif %}
                                <a href="{{ url_for('edit_assignment', assignment_id=assignment.id) }}" 
                                   class="btn btn-secondary btn-small">
                                    Edit
                                </a>
                                <form method="POST" 
                                      action="{{ url_for('delete_assignment', assignment_id=assignment.id) }}" 
                                      style="display: inline;"
                                      onsubmit="return confirm('Are you sure you want to delete this assignment?');">
                                    <button type="submit" class="btn btn-danger btn-small">
                                        Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <p>No assignments found matching your filters.</p>
            {% if priority_filter != 'all' or status_filter != 'all' %}
                <a href="{{ url_for('assignments') }}" class="btn btn-secondary">Clear Filters</a>
            {% else %}
                <a href="{{ url_for('add_assignment') }}" class="btn btn-primary">Add Your First Assignment</a>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
function markComplete(assignmentId) {
    if (confirm('Mark this assignment as completed?')) {
        fetch(`/assignment/complete/${assignmentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error marking assignment as complete');
            console.error('Error:', error);
        });
    }
}

const now = new Date('{{ now.isoformat() }}');
</script>
{% endblock %}
